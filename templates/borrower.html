{% extends "base.html" %}
{% block content %}

<h2>{{ borrower.name }}</h2>
<p>Rate: {{ borrower.rate }}%</p>
<p>Notes: {{ borrower.notes }}</p>

<!-- Edit Borrower -->
<h3>Edit Borrower</h3>
<form method="post" action="{{ url_for('edit_borrower', id=borrower.id) }}">
  <input type="text" name="name" value="{{ borrower.name }}" required>
  <input type="number" name="rate" step="0.01" value="{{ borrower.rate }}" required>
  <input type="text" name="notes" value="{{ borrower.notes }}">
  <button type="submit" class="btn btn-warning">Update</button>
</form>

<hr>

<!-- Mode Toggle -->
<h3>Balances</h3>
<form method="get" action="{{ url_for('borrower_detail', id=borrower.id) }}">
  <input type="hidden" name="page" value="1">
  <label class="me-3">
    <input type="radio" name="mode" value="simple" {% if mode == 'simple' %}checked{% endif %} onchange="this.form.submit()"> Simple Interest
  </label>
  <label>
    <input type="radio" name="mode" value="compound" {% if mode == 'compound' %}checked{% endif %} onchange="this.form.submit()"> Compound Interest
  </label>
</form>

<p>{{ mode|capitalize }} Balance: â‚¹{{ balance|inr }}</p>
<a href="{{ url_for('export_csv', id=borrower.id, mode=mode) }}">Download {{ mode|capitalize }} Ledger (CSV)</a>

<hr>

<!-- Ledger -->
<h3>{{ mode|capitalize }} Ledger</h3>
<p>Showing page {{ page }} of {{ total_pages }} ({{ total }} records)</p>

<table class="table table-bordered">
  <tr>
    <th>Date</th><th>Type</th><th>Amount</th><th>Days</th><th>Interest</th><th>Balance</th><th>Actions</th>
  </tr>
  {% for row in ledger %}
  <tr>
    <td>{{ row.date }}</td>
    <td>{{ row.type }}</td>
    <td>{{ row.amount|inr }}</td>
    <td>{{ row.days }}</td>
    <td>{{ row.interest|inr }}</td>
    <td>{{ row.balance|inr }}</td>
    <td>
      {% if row.type != 'accrual' %}
      <!-- Delete -->
      <form method="post" action="{{ url_for('delete_transaction', txn_id=row.id, borrower_id=borrower.id) }}" style="display:inline;">
        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Delete this transaction?');">Delete</button>
      </form>
      <!-- Edit -->
      <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#editModal{{ row.id }}">Edit</button>

      <!-- Edit Modal -->
      <div class="modal fade" id="editModal{{ row.id }}" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <form method="post" action="{{ url_for('edit_transaction', txn_id=row.id, borrower_id=borrower.id) }}">
              <div class="modal-header">
                <h5 class="modal-title">Edit Transaction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <label>Type</label>
                <select name="type" class="form-control">
                  <option value="loan" {% if row.type == "loan" %}selected{% endif %}>Loan</option>
                  <option value="payment" {% if row.type == "payment" %}selected{% endif %}>Payment</option>
                </select>
                <label>Amount</label>
                <input type="number" step="0.01" name="amount" value="{{ row.amount }}" class="form-control" required>
                <label>Date</label>
                <input type="date" name="date" value="{{ row.date }}" class="form-control" required>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Save changes</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      {% endif %}
    </td>
  </tr>
  {% endfor %}
</table>

<!-- Pagination -->
<nav>
  <ul class="pagination">
    {% if page > 1 %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('borrower_detail', id=borrower.id, page=page-1, mode=mode) }}">Previous</a>
      </li>
    {% endif %}
    {% for p in range(1, total_pages+1) %}
      <li class="page-item {% if p == page %}active{% endif %}">
        <a class="page-link" href="{{ url_for('borrower_detail', id=borrower.id, page=p, mode=mode) }}">{{ p }}</a>
      </li>
    {% endfor %}
    {% if page < total_pages %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('borrower_detail', id=borrower.id, page=page+1, mode=mode) }}">Next</a>
      </li>
    {% endif %}
  </ul>
</nav>

<hr>

<!-- Add Transaction -->
<h3>Add Transaction</h3>
<form method="post" action="{{ url_for('add_transaction', id=borrower.id) }}">
  <select name="type">
    <option value="loan">Loan</option>
    <option value="payment">Payment</option>
  </select>
  <input type="number" name="amount" step="0.01" required>
  <input type="date" name="date">
  <button type="submit" class="btn btn-success">Add</button>
</form>

{% endblock %}
